name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-title-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            chore
          scopes: |
            crypto
            auth
            vault
            sync
            security
            ui
            api
            db
            ci
          requireScope: false

  code-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check for large files
        run: |
          large_files=$(find . -type f -size +5M -not -path "./.git/*" -not -path "./node_modules/*")
          if [ -n "$large_files" ]; then
            echo "âŒ Large files detected (>5MB):"
            echo "$large_files"
            exit 1
          fi
      
      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}

  size-label:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Add size label
        uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size/xs'
          xs_max_size: 10
          s_label: 'size/s'
          s_max_size: 100
          m_label: 'size/m'
          m_max_size: 500
          l_label: 'size/l'
          l_max_size: 1000
          xl_label: 'size/xl'

  comment-preview:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Comment PR with deployment info
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const comment = `
            ## ðŸš€ Preview Deployment
            
            Your changes will be available for preview once CI passes.
            
            **Frontend Preview:** \`https://pr-${prNumber}-frontend.preview.your-domain.com\`
            **Backend Preview:** \`https://pr-${prNumber}-backend.preview.your-domain.com\`
            
            **Checklist:**
            - [ ] All tests passing
            - [ ] No security vulnerabilities
            - [ ] Code reviewed
            - [ ] Documentation updated
            `;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
